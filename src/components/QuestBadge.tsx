import { useState, useEffect } from 'react'
import { motion } from 'motion/react'
import './QuestBadge.css'

const RING_ARC =
  'M10.0016 2.98376e-08C6.96107 1.75508 4.43608 4.2796 2.68043 7.31982C0.924776 10.36 0.000328508 13.8088 8.75367e-08 17.3196C-0.000328333 20.8303 0.923474 24.2793 2.67856 27.3198C4.43364 30.3604 6.95816 32.8854 9.99838 34.641C13.0386 36.3967 16.4874 37.3211 19.9981 37.3214C23.5089 37.3218 26.9578 36.398 29.9984 34.6429C33.0389 32.8878 35.5639 30.3633 37.3196 27.3231C39.0752 24.2828 39.9997 20.834 40 17.3233L38 17.3231C37.9997 20.4828 37.1677 23.5867 35.5876 26.3229C34.0075 29.0591 31.735 31.3312 28.9985 32.9107C26.262 34.4903 23.158 35.3217 19.9983 35.3214C16.8387 35.3211 13.7347 34.4891 10.9985 32.9091C8.26234 31.329 5.99028 29.0565 4.4107 26.32C2.83113 23.5835 1.9997 20.4794 2 17.3198C2.0003 14.1601 2.8323 11.0562 4.41238 8.31999C5.99247 5.58379 8.26497 3.31172 11.0015 1.73214L10.0016 2.98376e-08Z'
const RING_STROKE =
  'M10.0016 0L10.8677 -0.499919L10.3678 -1.36599L9.5017 -0.866072L10.0016 0ZM8.75367e-08 17.3196L-1 17.3195L8.75367e-08 17.3196ZM9.99838 34.641L9.4983 35.507L9.99838 34.641ZM19.9981 37.3214L19.998 38.3214L19.9981 37.3214ZM40 17.3233L41 17.3234L41.0001 16.3234L40.0001 16.3233L40 17.3233ZM38 17.3231L38.0001 16.3231L37.0001 16.323L37 17.323L38 17.3231ZM35.5876 26.3229L34.7216 25.8228L35.5876 26.3229ZM28.9985 32.9107L28.4986 32.0447L28.9985 32.9107ZM19.9983 35.3214L19.9984 34.3214L19.9983 35.3214ZM10.9985 32.9091L11.4986 32.0431L10.9985 32.9091ZM4.4107 26.32L5.27677 25.8201L4.4107 26.32ZM11.0015 1.73214L11.5014 2.59822L12.3674 2.0983L11.8675 1.23223L11.0015 1.73214ZM10.0016 0L9.5017 -0.866072C6.30913 0.976764 3.65788 3.62751 1.81445 6.81974L2.68043 7.31982L3.54641 7.8199C5.21427 4.9317 7.61302 2.5334 10.5015 0.866072L10.0016 0ZM2.68043 7.31982L1.81445 6.81974C-0.0289847 10.012 -0.999655 13.6332 -1 17.3195L8.75367e-08 17.3196L1 17.3197C1.00031 13.9845 1.87854 10.7081 3.54641 7.8199L2.68043 7.31982ZM8.75367e-08 17.3196L-1 17.3195C-1.00034 21.0057 -0.0303519 24.6272 1.81248 27.8197L2.67856 27.3198L3.54463 26.8199C1.8773 23.9314 0.999688 20.6549 1 17.3197L8.75367e-08 17.3196ZM2.67856 27.3198L1.81248 27.8197C3.65532 31.0123 6.30607 33.6636 9.4983 35.507L9.99838 34.641L10.4985 33.775C7.61025 32.1072 5.21196 29.7084 3.54463 26.8199L2.67856 27.3198ZM9.99838 34.641L9.4983 35.507C12.6905 37.3504 16.3118 38.3211 19.998 38.3214L19.9981 37.3214L19.9982 36.3214C16.663 36.3211 13.3867 35.4429 10.4985 33.775L9.99838 34.641ZM19.9981 37.3214L19.998 38.3214C23.6843 38.3218 27.3057 37.3518 30.4983 35.509L29.9984 34.6429L29.4985 33.7768C26.6099 35.4441 23.3334 36.3218 19.9982 36.3214L19.9981 37.3214ZM29.9984 34.6429L30.4983 35.509C33.6909 33.6661 36.3421 31.0154 38.1856 27.8231L37.3196 27.3231L36.4536 26.823C34.7857 29.7112 32.387 32.1095 29.4985 33.7768L29.9984 34.6429ZM37.3196 27.3231L38.1856 27.8231C40.029 24.6309 40.9997 21.0097 41 17.3234L40 17.3233L39 17.3232C38.9997 20.6584 38.1215 23.9348 36.4536 26.823L37.3196 27.3231ZM40 17.3233L40.0001 16.3233L38.0001 16.3231L38 17.3231L37.9999 18.3231L39.9999 18.3233L40 17.3233ZM38 17.3231L37 17.323C36.9997 20.3072 36.2139 23.2386 34.7216 25.8228L35.5876 26.3229L36.4536 26.823C38.1215 23.9348 38.9997 20.6584 39 17.3232L38 17.3231ZM35.5876 26.3229L34.7216 25.8228C33.2293 28.407 31.0831 30.5529 28.4986 32.0447L28.9985 32.9107L29.4985 33.7768C32.387 32.1095 34.7857 29.7112 36.4536 26.823L35.5876 26.3229ZM28.9985 32.9107L28.4986 32.0447C25.9142 33.5365 22.9825 34.3217 19.9984 34.3214L19.9983 35.3214L19.9982 36.3214C23.3334 36.3218 26.6099 35.4441 29.4985 33.7768L28.9985 32.9107ZM19.9983 35.3214L19.9984 34.3214C17.0143 34.3212 14.0828 33.5354 11.4986 32.0431L10.9985 32.9091L10.4985 33.775C13.3867 35.4429 16.663 36.3211 19.9982 36.3214L19.9983 35.3214ZM10.9985 32.9091L11.4986 32.0431C8.91444 30.5508 6.76859 28.4045 5.27677 25.8201L4.4107 26.32L3.54463 26.8199C5.21196 29.7084 7.61025 32.1072 10.4985 33.775L10.9985 32.9091ZM4.4107 26.32L5.27677 25.8201C3.78495 23.2356 2.99972 20.304 3 17.3199L2 17.3198L1 17.3197C0.999688 20.6549 1.8773 23.9314 3.54463 26.8199L4.4107 26.32ZM2 17.3198L3 17.3199C3.00028 14.3357 3.78606 11.4043 5.27836 8.82007L4.41238 8.31999L3.54641 7.8199C1.87854 10.7081 1.00031 13.9845 1 17.3197L2 17.3198ZM4.41238 8.31999L5.27836 8.82007C6.77067 6.23588 8.91691 4.09004 11.5014 2.59822L11.0015 1.73214L10.5015 0.866072C7.61302 2.5334 5.21427 4.9317 3.54641 7.8199L4.41238 8.31999ZM11.0015 1.73214L11.8675 1.23223L10.8677 -0.499919L10.0016 0L9.13555 0.499919L10.1354 2.23206L11.0015 1.73214Z'

const BADGE_MASK =
  'M11.418 0C15.6607 0 19.5944 1.3219 22.8311 3.5752L20.4512 6.97168L2.37012 7L0 3.57812C3.23758 1.32285 7.17318 0 11.418 0Z'

const QUEST_ICON_PATH =
  'M6 1C8.76142 1 11 3.23858 11 6C11 8.76142 8.76142 11 6 11C3.23858 11 1 8.76142 1 6C1 3.23858 3.23858 1 6 1ZM3.57812 4.67188C3.50527 4.59902 3.39219 4.59902 3.31934 4.67188L2.30273 5.6875C2.18981 5.80042 2.27039 5.99707 2.43066 5.99707H3.08594C3.08594 7.60709 4.38999 8.9111 6 8.91113C6.37867 8.91113 6.74286 8.83877 7.07422 8.7041C7.31827 8.60575 7.38402 8.29222 7.19824 8.10645C7.09989 8.0082 6.94676 7.96785 6.81934 8.02246C6.5644 8.12441 6.2877 8.18262 6 8.18262C4.79432 8.18258 3.81445 7.20276 3.81445 5.99707H4.4668C4.63053 5.99685 4.71025 5.80036 4.59375 5.6875L3.57812 4.67188ZM6 3.08301C5.62128 3.08302 5.25718 3.15631 4.92578 3.29102C4.68173 3.38937 4.61598 3.7029 4.80176 3.88867C4.90011 3.98686 5.04963 4.02628 5.18066 3.97168C5.4319 3.86614 5.71238 3.81153 6 3.81152C7.20559 3.81152 8.18536 4.79152 8.18555 5.99707H7.5332C7.36962 5.99739 7.28997 6.19379 7.40625 6.30664L8.42285 7.32324C8.49566 7.39587 8.60787 7.3959 8.68066 7.32324L9.69727 6.30664C9.80988 6.19374 9.73009 5.99725 9.56641 5.99707H8.91406C8.91388 4.38719 7.60992 3.08301 6 3.08301Z'

/* Posições do ícone: centro (transition) e topo (final) */
const ICON_CENTER = { x: '-50%', y: '-50%', left: '50%', top: '50%', width: 20, height: 20 }
const ICON_TOP = { x: '-50%', y: '0%', left: '50%', top: -2, width: 10, height: 10 }

const iconSpring = { type: 'spring' as const, stiffness: 200, damping: 20 }

interface QuestBadgeProps {
  value?: number
  pct?: number
  transition?: boolean
  onTransitionDone?: () => void
}

export default function QuestBadge({ value = 0, pct = 0, transition = false, onTransitionDone }: QuestBadgeProps) {
  const [settled, setSettled] = useState(!transition)
  const deg = (pct / 100) * 360

  useEffect(() => {
    if (transition) {
      setSettled(false)
      const t = setTimeout(() => {
        setSettled(true)
        onTransitionDone?.()
      }, 1200)
      return () => clearTimeout(t)
    }
  }, [transition, onTransitionDone])

  const isCenter = transition && !settled

  return (
    <div className="quest-badge" data-name="Quest">
      <div className="quest-badge__bg" />

      {/* Number — fades in when settled */}
      <motion.div
        className="quest-badge__number-wrap"
        initial={false}
        animate={{ opacity: settled ? 1 : 0, scale: settled ? 1 : 0.5 }}
        transition={{ duration: 0.35, ease: 'easeOut' }}
      >
        <p className="quest-badge__number">{value}</p>
      </motion.div>

      <div className="quest-badge__trailing" />

      <div
        className="quest-badge__progress"
        style={{ '--pct-deg': `${deg}deg` } as React.CSSProperties}
      >
        <div className="quest-badge__progress-inner">
          <svg
            className="quest-badge__progress-svg"
            fill="none"
            preserveAspectRatio="none"
            viewBox="0 0 40 37.3214"
          >
            <defs>
              <mask fill="white" id="quest-counter-ring-mask">
                <path d={RING_ARC} />
              </mask>
              <linearGradient id="questCounterGrad" x1="0" y1="37" x2="40" y2="0">
                <stop offset="0%" stopColor="#4b4b4b" />
                <stop offset="100%" stopColor="#fbfbfb" />
              </linearGradient>
            </defs>
            <path
              d={RING_STROKE}
              fill="url(#questCounterGrad)"
              mask="url(#quest-counter-ring-mask)"
            />
          </svg>
        </div>
      </div>

      {/* Badge mask — only visible when settled */}
      <motion.div
        className="quest-badge__badge"
        initial={false}
        animate={{ opacity: settled ? 1 : 0 }}
        transition={{ duration: 0.3 }}
      >
        <div className="quest-badge__badge-mask">
          <svg
            className="quest-badge__badge-mask-svg"
            fill="none"
            preserveAspectRatio="none"
            viewBox="0 0 22.8311 7"
          >
            <path d={BADGE_MASK} fill="#121212" />
          </svg>
        </div>
      </motion.div>

      {/* Animated icon — starts large in center, slides to small at top */}
      <motion.div
        className="quest-badge__animated-icon"
        initial={false}
        animate={{
          left: isCenter ? ICON_CENTER.left : ICON_TOP.left,
          top: isCenter ? ICON_CENTER.top : ICON_TOP.top,
          x: isCenter ? ICON_CENTER.x : ICON_TOP.x,
          y: isCenter ? ICON_CENTER.y : ICON_TOP.y,
          width: isCenter ? ICON_CENTER.width : ICON_TOP.width,
          height: isCenter ? ICON_CENTER.height : ICON_TOP.height,
        }}
        transition={iconSpring}
      >
        <svg width="100%" height="100%" viewBox="0 0 12 12" fill="none" aria-hidden>
          <path
            fillRule="evenodd"
            clipRule="evenodd"
            d={QUEST_ICON_PATH}
            fill="#b2b2b2"
          />
        </svg>
      </motion.div>
    </div>
  )
}
